<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Dashboard | SurveyBD</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .recent-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .activity-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .survey-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .survey-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            transition: var(--transition);
            cursor: pointer;
        }

        .survey-list-item:hover {
            border-color: rgba(99, 102, 241, 0.3);
            background: var(--bg-card-hover);
        }

        .survey-list-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.published {
            background: var(--success)
        }

        .status-dot.draft {
            background: var(--text-muted)
        }

        .status-dot.closed {
            background: var(--danger)
        }

        @media(max-width:1100px) {
            .stat-grid {
                grid-template-columns: repeat(2, 1fr)
            }

            .recent-grid {
                grid-template-columns: 1fr
            }
        }

        @media(max-width:600px) {
            .stat-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <div class="main-content">
            <header class="topbar" id="topbar"></header>
            <main class="page-content fade-in" id="main"></main>
        </div>
    </div>
    <div id="toast-container"></div>

    <script src="js/i18n.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let currentUser;

        function onLangChange() { if (currentUser) renderPage(); }

        function renderPage() {
            const lang = I18n.lang;
            const surveys = DB.getSurveys();
            const responses = DB.getResponses();
            const users = DB.getUsers();
            const isAdmin = currentUser.role === 'admin';
            const isCreator = currentUser.role === 'creator' || isAdmin;
            const mySurveys = isAdmin ? surveys : surveys.filter(s => s.creatorId === currentUser.id);
            const activeSurveys = mySurveys.filter(s => s.status === 'published');
            const totalResponses = isAdmin ? responses.length : responses.filter(r => mySurveys.some(s => s.id === r.surveyId)).length;
            const recentSurveys = [...mySurveys].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            // Stat cards
            const stats = [
                { icon: 'üìã', color: 'rgba(99,102,241,0.15)', label: I18n.t('dashboard.totalSurveys'), value: mySurveys.length, change: '+2', up: true },
                { icon: 'üì®', color: 'rgba(16,185,129,0.15)', label: I18n.t('dashboard.totalResponses'), value: totalResponses, change: '+12', up: true },
                { icon: 'üü¢', color: 'rgba(6,182,212,0.15)', label: I18n.t('dashboard.activeSurveys'), value: activeSurveys.length, change: '0', up: true },
                ...(isAdmin ? [{ icon: 'üë•', color: 'rgba(245,158,11,0.15)', label: I18n.t('dashboard.totalUsers'), value: users.length, change: '+1', up: true }] : [{ icon: 'üìà', color: 'rgba(168,85,247,0.15)', label: I18n.t('dashboard.responseRate'), value: mySurveys.length ? Math.round(totalResponses / Math.max(mySurveys.length, 1) * 10) + '%' : '0%', change: '', up: true }])
            ];

            const statsHtml = stats.map(s => `
    <div class="stat-card">
      <div class="stat-icon" style="background:${s.color}">${s.icon}</div>
      <div class="stat-value">${s.value}</div>
      <div class="stat-label">${s.label}</div>
      ${s.change ? `<div class="stat-change up"><i class="fas fa-arrow-up"></i> ${s.change} ${I18n.t('dashboard.thisMonth')}</div>` : ''}
    </div>`).join('');

            // Recent surveys
            const surveyListHtml = recentSurveys.length ? recentSurveys.map(s => {
                const resCount = responses.filter(r => r.surveyId === s.id).length;
                const title = lang === 'th' && s.titleTh ? s.titleTh : s.title;
                return `
    <div class="survey-list-item" onclick="window.location.href='builder.html?id=${s.id}'">
      <div class="survey-list-icon" style="background:rgba(99,102,241,0.1)">üìã</div>
      <div style="flex:1;min-width:0">
        <div class="font-bold truncate">${Utils.escapeHtml(title)}</div>
        <div class="text-sm text-secondary" style="margin-top:4px">${s.questions?.length || 0} ${I18n.t('survey.questions')} ¬∑ ${resCount} ${I18n.t('survey.responses')}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
        ${Utils.getSurveyStatusBadge(s.status, lang)}
        <span class="text-xs text-muted">${Utils.timeAgo(s.createdAt)}</span>
      </div>
    </div>`;
            }).join('') : `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">${I18n.t('survey.noSurveys')}</div><div class="empty-desc">${I18n.t('survey.noSurveysDesc')}</div>${isCreator ? `<a href="builder.html" class="btn btn-primary" style="margin-top:16px"><i class="fas fa-plus"></i> ${I18n.t('dashboard.createNew')}</a>` : ''}</div>`;

            // Activity
            const allResponses = isAdmin ? responses : responses.filter(r => mySurveys.some(s => s.id === r.surveyId));
            const recentActivity = [...allResponses].sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)).slice(0, 6);
            const activityHtml = recentActivity.length ? recentActivity.map(r => {
                const sv = surveys.find(s => s.id === r.surveyId);
                const svTitle = sv ? (lang === 'th' && sv.titleTh ? sv.titleTh : sv.title) : 'Unknown';
                return `<div class="activity-item">
      <div class="activity-dot" style="background:rgba(16,185,129,0.15)">üì®</div>
      <div style="flex:1;min-width:0">
        <div class="text-sm font-bold">${Utils.escapeHtml(r.respondentName || 'Anonymous')}</div>
        <div class="text-xs text-muted truncate">${Utils.escapeHtml(svTitle)}</div>
        <div class="text-xs text-muted" style="margin-top:2px">${Utils.timeAgo(r.submittedAt)}</div>
      </div>
    </div>`;
            }).join('') : `<div class="empty-state" style="padding:24px"><div class="empty-icon" style="font-size:32px">üì≠</div><div class="empty-desc">${I18n.t('common.noData')}</div></div>`;

            document.getElementById('main').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">${I18n.t('dashboard.title')}</div>
        <div class="page-desc">${I18n.t('dashboard.welcome')}, <strong>${Utils.escapeHtml(currentUser.name)}</strong> üëã</div>
      </div>
      ${isCreator ? `<a href="builder.html" class="btn btn-primary"><i class="fas fa-plus"></i> ${I18n.t('dashboard.createNew')}</a>` : ''}
    </div>

    <div class="stat-grid">${statsHtml}</div>

    <div class="recent-grid">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">${I18n.t('dashboard.recentSurveys')}</div>
          </div>
          ${isCreator ? `<a href="builder.html" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i> ${I18n.t('common.add')}</a>` : ''}
        </div>
        <div class="survey-list">${surveyListHtml}</div>
      </div>
      <div>
        <div class="card">
          <div class="card-header"><div class="card-title">Recent Activity</div></div>
          <div class="activity-list">${activityHtml}</div>
        </div>
      </div>
    </div>`;

            // Update topbar title
            const titleEl = document.querySelector('.topbar-title');
            if (titleEl) titleEl.textContent = I18n.t('dashboard.title');
        }

        window.onload = () => {
            try {
                currentUser = Auth.guard();
                if (!currentUser) return;
                I18n.init();
                Components.init('dashboard');
                renderPage();
            } catch (err) {
                document.getElementById('main').innerHTML = `<div style="padding:40px;color:var(--danger);font-family:monospace;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2);border-radius:12px;margin:20px"><h3>‚ö†Ô∏è Error Loading Dashboard</h3><pre style="margin-top:12px;font-size:12px;white-space:pre-wrap">${err.stack || err.message}</pre></div>`;
                console.error('Dashboard error:', err);
            }
        };
    </script>
</body>

</html>